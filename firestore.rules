rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // ========== Admin Helper ==========
    // Checks if the requesting user has an entry in the 'admins' collection.
    // To grant admin access, create a document: admins/{userUid} with any data.
    function isAdmin() {
      return request.auth != null
          && exists(/databases/$(database)/documents/admins/$(request.auth.uid));
    }

    // ========== Registrations ==========
    // Users can read their own registration.
    // Users can create their own registration ONLY IF one doesn't already exist
    //   (prevents the overwrite race condition).
    // Updates and deletes are admin-only.
    match /registrations/{userId} {
      allow read: if request.auth != null && (request.auth.uid == userId || isAdmin());
      allow create: if request.auth != null
                    && request.auth.uid == userId
                    && !exists(/databases/$(database)/documents/registrations/$(userId));
      allow update, delete: if isAdmin();
    }

    // ========== Problem Statements ==========
    // Any authenticated user can read.
    // Only admins can create, update, or delete.
    match /problemStatements/{docId} {
      allow read: if request.auth != null;
      allow write: if isAdmin();
    }

    // ========== Quest Selections (Lock Documents) ==========
    // Each user can read and create their own lock doc (userId must match).
    // Once created, nobody can update them (immutable lock).
    // Only admins can delete (to allow re-selection after admin removal).
    match /questSelections/{userId} {
      allow read: if request.auth != null && request.auth.uid == userId;
      allow create: if request.auth != null
                    && request.auth.uid == userId
                    && request.resource.data.userId == userId;
      allow update: if false;
      allow delete: if isAdmin();
    }

    // ========== Admins Collection ==========
    // Only readable by the admin themselves. Never writable from client.
    // Seed this collection manually via Firebase Console.
    match /admins/{uid} {
      allow read: if request.auth != null && request.auth.uid == uid;
      allow write: if false;
    }

    // ========== Contact Submissions ==========
    match /contactSubmissions/{docId} {
      allow create: if request.auth != null;
      allow read, update, delete: if false;
    }

    // ========== Default: Deny everything else ==========
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
